---
- name: Add repository clickhouse
  become: true
  block:
    - name: Install dependencies
      ansible.builtin.apt:
        name:
          - curl
          - gnupg
          - ca-certificates
          - apt-transport-https
    - name: Get key clickhouse repository
      ansible.builtin.get_url:
        url: https://packages.clickhouse.com/rpm/lts/repodata/repomd.xml.key
        dest: /usr/share/keyrings/clickhouse-keyring.asc
        mode: '0755'
    - name: Add clickhouse in apt lists
      ansible.builtin.apt_repository:
        repo: "deb [signed-by=/usr/share/keyrings/clickhouse-keyring.asc] https://packages.clickhouse.com/deb stable main"
- name: Install Clickhouse service
  become: true
  ansible.builtin.apt:
    name:
      - clickhouse-common-static={{ clickhouse_version }}
      - clickhouse-client={{ clickhouse_version }}
      - clickhouse-server={{ clickhouse_version }}
  notify: Start clickhouse service
- name: Flush handlers
  ansible.builtin.meta: flush_handlers
- name: Create database
  ansible.builtin.command: "clickhouse-client -q 'create database logs;'"
  register: create_db
  failed_when: create_db.rc != 0 and create_db.rc != 82
  changed_when: create_db.rc == 0
